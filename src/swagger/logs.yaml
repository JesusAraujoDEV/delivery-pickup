tags:
  - name: Logs

paths:
  /api/dp/v1/logs:
    get:
      tags: [Logs]
      summary: Ver historial general (con filtros opcionales)
      description: |
        Endpoint unificado para obtener logs. Soporta filtrado por tipo de recurso (resource),
        estado, y rango de fechas. Sin filtros devuelve todos los logs (Live Feed).
        
        **Ejemplos de uso:**
        - `GET /api/dp/v1/logs` - Todos los logs
        - `GET /api/dp/v1/logs?resource=orders` - Solo logs de orders
        - `GET /api/dp/v1/logs?resource=zones` - Solo logs de zones
        - `GET /api/dp/v1/logs?resource=thresholds` - Solo logs de thresholds
        - `GET /api/dp/v1/logs?resource=orders&status=DELIVERED` - Combinar filtros
      parameters:
        - in: query
          name: resource
          required: false
          description: Filtrar por tipo de recurso (orders, zones, thresholds)
          schema:
            type: string
            enum: [orders, zones, thresholds]
          example: orders
        - in: query
          name: status
          required: false
          description: Filtrar por estado de transición (status_to)
          schema:
            type: string
            enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED, ACTION]
        - in: query
          name: from
          required: false
          description: Fecha inicio ISO (timestamp_transition)
          schema:
            type: string
            format: date-time
        - in: query
          name: to
          required: false
          description: Fecha fin ISO (timestamp_transition)
          schema:
            type: string
            format: date-time
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Lista de logs
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Log'

  /api/dp/v1/logs/{log_id}:
    get:
      tags: [Logs]
      summary: Ver detalle de un evento
      parameters:
        - in: path
          name: log_id
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Log
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Log'
        '404':
          description: No encontrado

  /api/dp/v1/logs/by-order/{order_id}:
    get:
      tags: [Logs]
      summary: Ver la historia de una orden específica
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 200
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Lista de logs para order_id
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Log'

  /api/dp/v1/logs/search:
    get:
      tags: [Logs]
      summary: Filtrar por estatus, fechas, usuarios
      description: |
        Endpoint equivalente a GET /logs pero explícito para búsqueda.
        Permite filtrar por status_to y rango de fechas (timestamp_transition).
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED, ACTION]
        - in: query
          name: from
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: to
          required: false
          schema:
            type: string
            format: date-time
        - in: query
          name: limit
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 50
        - in: query
          name: offset
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Lista de logs filtrados
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Log'

components:
  schemas:
    OrderSummary:
      type: object
      properties:
        order_id:
          type: string
          format: uuid
        readable_id:
          type: string
        current_status:
          type: string

    Log:
      type: object
      properties:
        log_id:
          type: string
          format: uuid
        order_id:
          type: string
          format: uuid
          nullable: true
        timestamp_transition:
          type: string
          format: date-time
        status_from:
          type: string
          nullable: true
        status_to:
          type: string
        cancellation_reason:
          type: string
          nullable: true
        http_method:
          type: string
          nullable: true
          example: POST
        path:
          type: string
          nullable: true
          example: /api/dp/v1/zones
        resource:
          type: string
          nullable: true
          example: zones
        logs_type:
          type: string
          nullable: true
          enum: [orders, zones, thresholds]
          description: Tipo de log (orders, zones, thresholds). Se asigna automáticamente basado en el recurso.
          example: zones
        manager:
          description: |
            Fallback desde JWT: "Nombre - email" (o desde manager_display persistido).
          type: string
          nullable: true
          example: Usuario - usuario.p2@charlotte.com
        manager_display:
          type: string
          nullable: true
          description: Fallback calculado desde JWT (si viene Authorization).
        order:
          $ref: '#/components/schemas/OrderSummary'