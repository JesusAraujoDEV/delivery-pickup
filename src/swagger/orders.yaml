tags:
  - name: Orders

paths:
  /api/dp/v1/orders:
    get:
      tags: [Orders]
      summary: Listado general de órdenes
      parameters:
        - in: query
          name: status
          required: false
          schema:
            type: string
            enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED]
        - in: query
          name: date
          required: false
          description: '"today" o fecha "YYYY-MM-DD" (filtra por timestamp_creation en rango UTC 00:00Z-00:00Z)'
          schema:
            type: string
            example: today
      responses:
        '200':
          description: Lista de órdenes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderListItem'
    post:
      tags: [Orders]
      summary: Crear orden
      description: |
        Crea la orden en DP.

        Nota: la inyección a Cocina NO ocurre en la creación. Se realiza cuando el admin cambia el estado
        con `PATCH /api/dp/v1/orders/{order_id}/status` hacia `IN_KITCHEN`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderInput'
      responses:
        '201':
          description: Orden creada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Order'

  /api/dp/v1/orders/active:
    get:
      tags: [Orders]
      summary: Listado de órdenes activas
      description: Devuelve todas las órdenes excepto las CANCELLED y las DELIVERED.
      parameters:
        - in: query
          name: date
          required: false
          description: '"today" o fecha "YYYY-MM-DD" (filtra por timestamp_creation en rango UTC 00:00Z-00:00Z)'
          schema:
            type: string
            example: today
      responses:
        '200':
          description: Lista de órdenes activas
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderListItem'

  /api/dp/v1/orders/status/{status}:
    get:
      tags: [Orders]
      summary: Listado de órdenes por status
      parameters:
        - in: path
          name: status
          required: true
          schema:
            type: string
            enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED]
        - in: query
          name: date
          required: false
          description: '"today" o fecha "YYYY-MM-DD" (filtra por timestamp_creation en rango UTC 00:00Z-00:00Z)'
          schema:
            type: string
            example: today
      responses:
        '200':
          description: Lista de órdenes con ese status
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OrderListItem'

  /api/dp/v1/orders/{order_id}/status:
    patch:
      tags: [Orders]
      summary: Cambiar estado de una orden (recomendado)
      security: []
      description: |
        Endpoint único para cambio de estado por destino. Reemplaza approve/cancel/dispatch/close.

        Integración Cocina: al cambiar el estado a `IN_KITCHEN`, DP inyecta la orden en Cocina
        haciendo un POST a `/api/kitchen/kds/inject`. Si falla, se devuelve `502` y el estado NO se actualiza.

        Reglas de transición (VALID_TRANSITIONS):
        - PENDING_REVIEW -> IN_KITCHEN, CANCELLED
        - IN_KITCHEN -> READY_FOR_DISPATCH, CANCELLED
        - READY_FOR_DISPATCH -> EN_ROUTE, DELIVERED, CANCELLED
        - EN_ROUTE -> DELIVERED, CANCELLED
        - DELIVERED -> (terminal)
        - CANCELLED -> (terminal)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            oneOf:
              - type: string
                format: uuid
              - type: string
                example: DL-8095
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetOrderStatusInput'
      responses:
        '200':
          description: Estado actualizado
          content:
            application/json:
              schema:
                type: object
                properties:
                  order_id:
                    type: string
                    format: uuid
                  readable_id:
                    type: string
                  status:
                    type: string
        '400':
          description: Payload/params inválidos o transición inválida
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Invalid status transition: IN_KITCHEN -> DELIVERED'
                  details:
                    type: object
                    properties:
                      from:
                        type: string
                      to:
                        type: string
                      allowed:
                        type: array
                        items:
                          type: string
        '404':
          description: Orden no encontrada
        '502':
          description: Error al inyectar en Cocina
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: 'Kitchen API error (502): Bad Gateway'
                  details:
                    type: object

  /api/dp/v1/orders/{order_id}:
    get:
      tags: [Orders]
      summary: Detalle completo de una orden (UUID o DL-####)
      description: |
        Permite consultar el detalle por:
        - `order_id` (UUIDv4)
        - `readable_id` (ej: DL-8095)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            oneOf:
              - type: string
                format: uuid
              - type: string
                example: DL-8095
      responses:
        '200':
          description: Detalle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'
        '400':
          description: ID inválido
        '404':
          description: Orden no encontrada

    patch:
      tags: [Orders]
      summary: Corregir datos de la orden
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PatchOrderInput'
      responses:
        '200':
          description: Orden actualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderDetail'
        '400':
          description: Payload/params inválidos
        '404':
          description: Orden no encontrada

  /api/dp/v1/orders/{order_id}/assign:
    patch:
      tags: [Orders]
      summary: Asignar motorizado (placeholder)
      parameters:
        - in: path
          name: order_id
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignOrderInput'
      responses:
        '200':
          description: Asignación registrada
        '400':
          description: Payload/params inválidos
        '404':
          description: Orden no encontrada

components:
  schemas:
    CatalogItem:
      type: object
      properties:
        product_id:
          type: string
        name:
          type: string
        price:
          type: number

    SetOrderStatusInput:
      type: object
      required: [status]
      properties:
        status:
          type: string
          enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED]

    OrderItem:
      type: object
      properties:
        product_id:
          type: string
        product_name:
          type: string
        quantity:
          type: integer
        unit_price:
          type: number
        notes:
          type: string
          nullable: true
          description: "Nota para cocina (ej: 'Sin mayonesa')"

    Customer:
      type: object
      properties:
        name:
          type: string
        phone:
          type: string
        email:
          type: string
        address:
          type: string

    CreateOrderInput:
      description: |
        Se aceptan 2 formatos para crear una orden:
        1) Formato DP (interno)
        2) Formato Kitchen-like (recomendado para integraciones)
      oneOf:
        - $ref: '#/components/schemas/DpCreateOrderInput'
        - $ref: '#/components/schemas/KitchenCreateOrderInput'

    DpCreateOrderInput:
      type: object
      required: [service_type, zone_id, customer, items]
      properties:
        service_type:
          type: string
          enum: [DELIVERY, PICKUP]
        zone_id:
          type: string
          format: uuid
          description: ID de la zona (dp_zones.zone_id). Requerido.
        customer:
          $ref: '#/components/schemas/Customer'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        shipping_cost:
          type: number
          description: Se ignora si se envía; el backend lo calcula desde la zona.

    KitchenCreateOrderInput:
      type: object
      required: [externalOrderId, sourceModule, serviceMode, displayLabel, customerName, zone_id, items]
      properties:
        externalOrderId:
          type: string
        sourceModule:
          type: string
          example: AC_MODULE
        serviceMode:
          type: string
          example: DINE_IN
        displayLabel:
          type: string
          example: Hamburguesa para Pepe
        customerName:
          type: string
          example: Pepe
        zone_id:
          type: string
          format: uuid
          description: ID de la zona (dp_zones.zone_id). Requerido.
        items:
          type: array
          items:
            type: object
            required: [productId, quantity]
            properties:
              productId:
                type: string
                description: ID del producto en Cocina
              quantity:
                type: integer
                minimum: 1
              notes:
                type: string
                nullable: true
      example:
        externalOrderId: a81bc81b-dead-4e5d-abff-90865d1e41c2
        sourceModule: AC_MODULE
        serviceMode: DINE_IN
        displayLabel: Hamburguesa para Pepe
        customerName: Pepe
        zone_id: 35f5a507-0eb3-4c78-a43d-cf0da720cf2d
        items:
          - productId: a5eccd9f-8b62-4ba5-ac9e-21ca43199718
            quantity: 3
            notes: Sin cebolla

    OrderStatus:
      type: object
      properties:
        status:
          type: string
          enum: [PENDING_REVIEW, IN_KITCHEN, READY_FOR_DISPATCH, EN_ROUTE, DELIVERED, CANCELLED]

    Order:
      type: object
      properties:
        order_id:
          type: string
        readable_id:
          type: string
        status:
          $ref: '#/components/schemas/OrderStatus'
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'

    OrderListItem:
      type: object
      description: Resumen de orden (basado en dp_orders)
      properties:
        order_id:
          type: string
          format: uuid
        readable_id:
          type: string
        customer_name:
          type: string
        customer_phone:
          type: string
        customer_email:
          type: string
          nullable: true
        delivery_address:
          type: string
          nullable: true
        service_type:
          type: string
          enum: [DELIVERY, PICKUP]
        current_status:
          type: string
        monto_total:
          type: number
          format: decimal
        monto_costo_envio:
          type: number
          format: decimal
        timestamp_creation:
          type: string
          format: date-time

    PatchOrderInput:
      type: object
      description: Campos editables para corrección (customer y/o campos directos de orders)
      properties:
        customer:
          type: object
          properties:
            name:
              type: string
            phone:
              type: string
            email:
              type: string
            address:
              type: string
        zone_id:
          type: string
          format: uuid
          nullable: true
        customer_name:
          type: string
        customer_phone:
          type: string
        customer_email:
          type: string
          nullable: true
        delivery_address:
          type: string
          nullable: true
        monto_total:
          type: number
        monto_costo_envio:
          type: number
        service_type:
          type: string

    AssignOrderInput:
      type: object
      description: 'Asignar motorizado (placeholder: aún no hay tabla drivers; se registra como log)'
      properties:
        manager_id:
          type: string
          format: uuid
        note:
          type: string

    OrderDetail:
      type: object
      description: Detalle completo (order + items + logs)
      properties:
        order_id:
          type: string
          format: uuid
        readable_id:
          type: string
        customer_name:
          type: string
        customer_phone:
          type: string
        customer_email:
          type: string
          nullable: true
        delivery_address:
          type: string
          nullable: true
        service_type:
          type: string
          enum: [DELIVERY, PICKUP]
        current_status:
          type: string
        monto_total:
          type: number
          format: decimal
        monto_costo_envio:
          type: number
          format: decimal
        timestamp_creation:
          type: string
          format: date-time
        zone:
          type: object
          nullable: true
        items:
          type: array
          items:
            type: object
        logs:
          type: array
          items:
            type: object
